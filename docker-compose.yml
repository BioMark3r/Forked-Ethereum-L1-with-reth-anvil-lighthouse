services:
  reth-fork:
    image: ghcr.io/paradigmxyz/reth:latest
    container_name: reth-fork
    restart: unless-stopped
    env_file: [.env]
    networks:
      ethnet:
        ipv4_address: 172.28.0.10
    volumes:
      - reth_data:/data
      - ./jwt.hex:/secrets/jwt.hex:ro
    ports:
      - "8545:8545"   # Reth JSON-RPC (HTTP)
      - "8551:8551"   # Engine API (JWT)
    command:
      - node
      - --chain
      - mainnet
      - --debug.rpc-consensus-url
      - ${MAINNET_RPC_WSS?Set MAINNET_RPC_WSS in .env}
      - --datadir
      - /data
      - --http
      - --http.addr
      - 0.0.0.0
      - --http.port
      - "8545"
      - --authrpc.addr
      - 0.0.0.0
      - --authrpc.port
      - "8551"
      - --authrpc.jwtsecret
      - /secrets/jwt.hex

  lighthouse:
    image: sigp/lighthouse:latest
    container_name: lighthouse
    restart: unless-stopped
    depends_on:
      - reth-fork
    entrypoint: ["lighthouse"]
    env_file: [.env]
    networks:
      ethnet:
        ipv4_address: 172.28.0.11
    volumes:
      - ./jwt.hex:/secrets/jwt.hex:ro
    ports:
      - "5052:5052"   # Lighthouse REST API
    command:
      - bn
      - --network
      - ${LIGHTHOUSE_NETWORK:-mainnet}
      - --execution-endpoint
      - http://172.28.0.10:8551     # <— talk to Reth by IP
      - --execution-jwt
      - /secrets/jwt.hex
      - --allow-insecure-genesis-sync
      - --http
      - --http-address
      - 0.0.0.0
      - --http-port
      - "5052"
      # optional:
      # - --http-allow-origin
      # - "*"

  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    restart: unless-stopped
    depends_on:
      - reth-fork
    entrypoint: ["/bin/sh", "-lc"]
    networks:
      ethnet:
        ipv4_address: 172.28.0.12
    ports:
      - "8547:8547"   # Anvil JSON-RPC
    command: >
      anvil
      --fork-url http://172.28.0.10:8545      # <— talk to Reth by IP
      $${FORK_BLOCK_NUMBER:+--fork-block-number $${FORK_BLOCK_NUMBER}}
      --chain-id 1
      --network-id 1
      --host 0.0.0.0
      --port 8547
      --auto-impersonate
      --mnemonic "test test test test test test test test test test test junk"

volumes:
  reth_data:

networks:
  ethnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
