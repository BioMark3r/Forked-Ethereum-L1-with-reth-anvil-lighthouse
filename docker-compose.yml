services:
  reth-fork:
    image: ghcr.io/paradigmxyz/reth:latest
    container_name: reth-fork
    restart: unless-stopped
    env_file: [.env]
    volumes:
      - reth_data:/data
      - ./jwt.hex:/secrets/jwt.hex:ro
      - ./reth.toml:/data/reth.toml:ro
      - ./start-reth.sh:/usr/local/bin/start-reth.sh:ro
    networks:
      ethnet:
        ipv4_address: 10.200.0.10
    ports:
      #- "8545:8545" # Default to Anvil only
      - "8551:8551"
      - "9001:9001"   # Reth Prometheus metrics
    entrypoint: ["/usr/local/bin/start-reth.sh"]

  lighthouse:
    image: sigp/lighthouse:latest
    container_name: lighthouse
    restart: unless-stopped
    depends_on:
      - reth-fork
    entrypoint: ["lighthouse"]
    env_file: [.env]
    networks:
      ethnet:
        ipv4_address: 10.200.0.11
    volumes:
      - ./jwt.hex:/secrets/jwt.hex:ro
    ports:
      - "5052:5052"   # Lighthouse REST API
      - "5054:5054"   # Lighthouse Prometheus metrics
    command:
      - bn
      - --network
      - ${LIGHTHOUSE_NETWORK:-mainnet}
      - --execution-endpoint
      - ${RETH_ENGINE_URL}     # <â€” talk to Reth by IP
      - --execution-jwt
      - /secrets/jwt.hex
      - --checkpoint-sync-url
      - https://mainnet.checkpoint.sigp.io
      - --http
      - --http-address
      - 0.0.0.0
      - --http-port
      - "5052"
      - --metrics
      - --metrics-address
      - 0.0.0.0
      - --metrics-port
      - "5054"
      # optional:
      # - --http-allow-origin
      # - "*"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    depends_on:
      reth-fork:
        condition: service_started
      lighthouse:
        condition: service_started
    networks:
      ethnet:
        ipv4_address: 10.200.0.13
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/-/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_healthy
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      ethnet:
        ipv4_address: 10.200.0.14
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro

  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    restart: unless-stopped
    depends_on:
      - reth-fork
    networks:
      ethnet:
        ipv4_address: 10.200.0.12
    ports:
      - "127.0.0.1:8547:8547"
    entrypoint: ["anvil"]
    command:
      - --fork-url
      - http://10.200.0.10:8545      # Reth RPC by IP
      - --host
      - 0.0.0.0
      - --port
      - "8547"
      - --chain-id
      - "1"
      - --mnemonic # This is a TEST mneumonic DO NOT USE for PRODUCTION
      - "gravity make plunge split install write release minor original energy steel borrow bronze gather pattern"
      - --accounts
      - "10"
      - --balance
      - "10000"


volumes:
  reth_data:

networks:
  ethnet:
    name: forknet
    driver: bridge
    ipam:
      config:
        - subnet: 10.200.0.0/16
