services:
  reth-fork:
    image: ghcr.io/paradigmxyz/reth:latest
    container_name: reth-fork
    restart: unless-stopped
    env_file: [.env]
    volumes:
      - reth_data:/data
      - ./jwt.hex:/secrets/jwt.hex:ro
    networks:
      ethnet:
        ipv4_address: 10.200.0.10
    ports:
      - "8545:8545"
      - "8551:8551"
    entrypoint: ["/bin/sh","-lc"]            # ← run a shell
    command: >
      set -e;
      RETH_CMD='reth node --chain mainnet --datadir /data
                --http --http.addr 0.0.0.0 --http.port 8545
                --authrpc.addr 0.0.0.0 --authrpc.port 8551
                --authrpc.jwtsecret /secrets/jwt.hex';
      if [ -n "$$RETH_TIP_HASH" ] && [ "$$RETH_TIP_HASH" != "null" ]; then
        echo "Using debug tip: $$RETH_TIP_HASH";
        RETH_CMD="$$RETH_CMD --debug.tip $$RETH_TIP_HASH";
      else
        echo "No RETH_TIP_HASH provided; starting without --debug.tip";
      fi;
      exec $$RETH_CMD

  lighthouse:
    image: sigp/lighthouse:latest
    container_name: lighthouse
    restart: unless-stopped
    depends_on:
      - reth-fork
    entrypoint: ["lighthouse"]
    env_file: [.env]
    networks:
      ethnet:
        ipv4_address: 10.200.0.11
    volumes:
      - ./jwt.hex:/secrets/jwt.hex:ro
    ports:
      - "5052:5052"   # Lighthouse REST API
    command:
      - bn
      - --network
      - ${LIGHTHOUSE_NETWORK:-mainnet}
      - --execution-endpoint
      - ${RETH_ENGINE_URL}     # <— talk to Reth by IP
      - --execution-jwt
      - /secrets/jwt.hex
      - --checkpoint-sync-url
      - https://mainnet.checkpoint.sigp.io
      - --http
      - --http-address
      - 0.0.0.0
      - --http-port
      - "5052"
      # optional:
      # - --http-allow-origin
      # - "*"

  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    restart: unless-stopped
    depends_on:
      - reth-fork
    networks:
      ethnet:
        ipv4_address: 10.200.0.12
    ports:
      - "8547:8547"
    entrypoint: ["anvil"]
    command:
      - --fork-url
      - http://10.200.0.10:8545      # Reth RPC by IP
      - --host
      - 0.0.0.0
      - --port
      - "8547"
      - --chain-id
      - "1"


volumes:
  reth_data:

networks:
  ethnet:
    driver: bridge
    ipam:
      config:
        - subnet: 10.200.0.0/16
